# Сводка изменений в Jenkinsfile

## Добавленные улучшения для диагностики проблемы SCP

### 1. Новый stage: "Очистка workspace и отладка"
- **Цель**: Очистить workspace от старых временных файлов и вывести отладочную информацию
- **Что делает**:
  - Выводит время запуска, номер билда, путь workspace
  - Пытается определить, является ли запуск ребилдом
  - Удаляет старые временные файлы (`prep_clone*.sh`, `scp_script*.sh`, `temp_data_cred.json` и др.)
  - Показывает содержимое директории до и после очистки

### 2. Новый stage: "Отладка параметров пайплайна"
- **Цель**: Показать все параметры пайплайна и проверить обязательные
- **Что делает**:
  - Выводит ВСЕ параметры пайплайна с их значениями
  - Проверяет обязательные параметры (`SERVER_ADDRESS`, `SSH_CREDENTIALS_ID`)
  - Показывает, какие параметры пустые/не заполнены

### 3. Новый stage: "Информация о коде и окружении"
- **Цель**: Показать информацию о git ревизии и системном окружении
- **Что делает**:
  - Показывает последние 3 коммита
  - Выводит информацию о системе (`uname -a`)
  - Проверяет наличие необходимых команд (`ssh`, `scp`, `rsync`, `jq`, `curl`)

### 4. Улучшенный stage: "Получение данных из Vault"
- **Цель**: Добавить детальную проверку `temp_data_cred.json`
- **Что изменилось**:
  - Добавлен отладочный вывод для каждого KV пути
  - Добавлена обработка ошибок при подключении к Vault
  - **Детальная проверка созданного файла**:
    - Проверка наличия файла
    - Проверка размера файла
    - Проверка валидности JSON (если установлен `jq`)
    - Показ структуры JSON (без секретов)
    - Показ первых 500 символов (с маскировкой паролей)

### 5. Ключевое улучшение: "Копирование скрипта на удаленный сервер"
- **Цель**: Исправить проблему со скрытыми ошибками SCP
- **Что изменилось кардинально**:

#### Старая версия scp_script.sh (проблемная):
```bash
ssh -i "$SSH_KEY" -q -o StrictHostKeyChecking=no \
    "$SSH_USER"@SERVER \
    "rm -rf /tmp/deploy-monitoring && mkdir -p /tmp/deploy-monitoring" >/dev/null 2>&1
scp -i "$SSH_KEY" -q -o StrictHostKeyChecking=no deploy_monitoring_script.sh ... >/dev/null 2>&1
# Все ошибки скрыты в /dev/null!
```

#### Новая версия scp_script.sh (с отладкой):
```bash
# 1. Проверка SSH ключа
if [ ! -f "$SSH_KEY" ]; then
    echo "[ERROR] SSH ключ не найден: $SSH_KEY"
    exit 1
fi

# 2. Тестирование SSH подключения (БЕЗ /dev/null!)
echo "[DEBUG] ТЕСТИРУЕМ SSH ПОДКЛЮЧЕНИЕ..."
if ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
    "$SSH_USER"@SERVER "echo '[OK] SSH подключение успешно' && hostname"; then
    echo "[OK] SSH подключение работает"
else
    echo "[ERROR] Ошибка SSH подключения!"
    # Показываем verbose вывод для диагностики
    ssh -i "$SSH_KEY" -v -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
        "$SSH_USER"@SERVER "echo test" || true
    exit 1
fi

# 3. Все SCP команды БЕЗ >/dev/null 2>&1
# 4. Проверка успешности каждой команды
```

### 6. Добавлена проверка файлов перед копированием
Перед запуском scp_script.sh добавлена проверка:
- `deploy_monitoring_script.sh` - существует ли
- `wrappers/` - существует ли папка
- `temp_data_cred.json` - существует ли

### 7. Улучшенный verify_script.sh
- Детальная проверка всех скопированных файлов на удаленном сервере
- Показ размеров файлов, прав доступа
- Подсчет количества файлов в папке wrappers

## Что это даст для диагностики

### При обычном запуске (который не работает):
1. **Увидим параметры** - какие значения используются
2. **Увидим состояние workspace** - есть ли конфликты файлов
3. **Увидим temp_data_cred.json** - создан ли, валиден ли
4. **Увидим реальную ошибку SCP** - какая именно команда падает
5. **Увидим verbose вывод SSH** - если есть проблемы с подключением

### При ребилде (который работает):
1. **Сравним параметры** - отличаются ли от обычного запуска
2. **Увидим те же проверки** - но они должны проходить успешно

## Ключевые отличия от старой версии

| Аспект | Старая версия | Новая версия |
|--------|---------------|--------------|
| **Ошибки SCP** | Скрыты в `/dev/null` | Видны в логах |
| **Проверка команд** | Нет проверки | Каждая команда проверяется |
| **Отладочный вывод** | Минимальный | Подробный для каждой операции |
| **Проверка файлов** | Только `test -s` | Детальная проверка размера, JSON и т.д. |
| **Очистка workspace** | Нет | Автоматическая очистка старых файлов |

## Как использовать для диагностики

1. **Запустите обычный пайплайн** (который не работает)
2. **Изучите логи** - на каком этапе ошибка
3. **Сравните с ребилдом** - какие параметры/файлы отличаются

## Наиболее вероятные места ошибок (по новой версии):

1. **Stage "Отладка параметров"** - пустые параметры
2. **Stage "Получение данных из Vault"** - проблема с `temp_data_cred.json`
3. **Stage "Копирование скрипта"**:
   - `[ERROR] SSH ключ не найден` - проблема с credentials
   - `[ERROR] Ошибка SSH подключения` - проблема с сетью/доступом
   - `[ERROR] Не удалось скопировать ...` - конкретная проблема с SCP

## Быстрый возврат к старой версии

Если нужно вернуться к старой версии, просто замените `scp_script.sh` на оригинальный (но оставьте проверки!).

---

**Итог**: Теперь при падении пайплайна будет понятно:
1. **Где** именно ошибка (конкретный stage и команда)
2. **Что** именно сломалось (конкретное сообщение об ошибке)
3. **Почему** (отладочная информация вокруг ошибки)

