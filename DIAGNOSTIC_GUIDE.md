# Руководство по расширенной диагностике сети в Jenkins

## Что добавлено в Jenkinsfile

### 1. Новый stage: "Расширенная диагностика сети и сервера"
Собирает полную информацию о:
- **Jenkins агенте** (имя хоста, IP адреса)
- **DNS разрешении** (проверка имени сервера)
- **Ping доступности** (базовая сетевая доступность)
- **Портах** (проверка порта 22 - SSH)
- **Маршрутизации** (трассировка до сервера)
- **Сетевых интерфейсах** (активные интерфейсы агента)
- **Таблице маршрутизации** (маршруты с агента)
- **Фаерволе** (проверка правил iptables)
- **SSH конфигурации** (конфиг и known_hosts)
- **Времени и дате** (синхронизация времени)
- **Альтернативных методах проверки** (telnet, прямое TCP)

### 2. Новый stage: "Сравнение с успешным ребилдом"
Сравнивает текущий запуск с последним успешным билдом:
- **Параметры пайплайна** (SERVER_ADDRESS, SSH_CREDENTIALS_ID и др.)
- **Jenkins агенты** (на каком агенте запускались)
- **Время и продолжительность** успешного билда
- **Тип билда** (был ли это ребилд)

## Как использовать для диагностики

### Шаг 1: Запустите обычный пайплайн (который не работает)

### Шаг 2: Изучите логи диагностики

#### Ключевые разделы для анализа:

**1. Диагностика DNS:**
```
[DIAG] Разрешение имени tvlds-mvp001939.cloud.delta.sbrf.ru...
```
- Убедитесь, что имя разрешается в правильный IP
- Если ошибка DNS - проблема с разрешением имен

**2. Проверка порта 22:**
```
[DIAG] Проверка порта 22 (SSH) на tvlds-mvp001939.cloud.delta.sbrf.ru:
[ERROR] Порт 22 закрыт/недоступен
```
- Это основная проблема! Порт 22 недоступен

**3. Трассировка маршрута:**
```
[DIAG] Трассировка до tvlds-mvp001939.cloud.delta.sbrf.ru:
```
- Показывает, где обрывается соединение
- Помогает определить проблемный сетевой узел

**4. Jenkins агенты:**
```
[DIAG] Имя хоста агента: pvlss-jenci0064
[DIAG] IP адреса агента:
```
- Запомните этот агент для сравнения

**5. Сравнение с успешным ребилдом:**
```
[COMPARE] Jenkins агенты:
[COMPARE]   Текущий: 'pvlss-jenci0064'
[COMPARE]   Успешный: 'другой-агент'
[COMPARE]   Совпадают: false
[WARNING] ⚠️  Билды запущены на разных Jenkins агентах!
```
- **Ключевая находка!** Если агенты разные - проблема в сетевой доступности

### Шаг 3: Запустите успешный ребилд

### Шаг 4: Сравните логи

#### Что сравнивать:

| Аспект | Обычный запуск (не работает) | Ребилд (работает) | Вывод |
|--------|-----------------------------|-------------------|--------|
| **Jenkins агент** | pvlss-jenci0064 | другой-агент | Проблема в агенте |
| **DNS разрешение** | 10.26.110.127 | 10.26.110.127 | DNS ок |
| **Порт 22** | Connection refused | Connected | Проблема сети |
| **Пинг** | Не работает | Работает | Сетевая доступность |
| **Параметры** | SERVER_ADDRESS: 'X' | SERVER_ADDRESS: 'X' | Параметры ок |

## Возможные сценарии и решения

### Сценарий 1: Разные Jenkins агенты
**Симптомы:**
- Обычный запуск на `pvlss-jenci0064`
- Ребилд на другом агенте
- Порт 22 недоступен только с `pvlss-jenci0064`

**Решение:**
1. Проверить сетевую доступность с `pvlss-jenci0064` до сервера
2. Проверить фаервол между агентом и сервером
3. Настроить пайплайн на использование того же агента, что и ребилд

### Сценарий 2: Временная проблема сети
**Симптомы:**
- Один и тот же агент
- Порт 22 иногда доступен, иногда нет
- Пинг нестабильный

**Решение:**
1. Проверить состояние сервера (запущен ли SSH демон)
2. Проверить сетевую инфраструктуру
3. Добавить retry логику в пайплайн

### Сценарий 3: Разные параметры
**Симптомы:**
- Разные значения `SERVER_ADDRESS`
- Разные `SSH_CREDENTIALS_ID`

**Решение:**
1. Исправить параметры пайплайна
2. Установить правильные дефолтные значения

## Команды для ручной проверки

Если нужно проверить вручную с Jenkins агента:

```bash
# 1. Проверить агент
hostname
ip addr show

# 2. Проверить DNS
nslookup tvlds-mvp001939.cloud.delta.sbrf.ru
dig tvlds-mvp001939.cloud.delta.sbrf.ru +short

# 3. Проверить ping
ping -c 3 tvlds-mvp001939.cloud.delta.sbrf.ru

# 4. Проверить порт 22
timeout 5 nc -zv tvlds-mvp001939.cloud.delta.sbrf.ru 22
# или
timeout 3 bash -c "echo > /dev/tcp/tvlds-mvp001939.cloud.delta.sbrf.ru/22"

# 5. Трассировка
traceroute -n -m 5 tvlds-mvp001939.cloud.delta.sbrf.ru

# 6. Проверить маршруты
ip route show
```

## Быстрое решение для Jenkinsfile

Если проблема в агенте `pvlss-jenci0064`, можно:

1. **Изменить лейбл агента** в Jenkinsfile:
```groovy
agent { label 'другой-агент-лейбл' }
```

2. **Добавить retry** при ошибках сети:
```groovy
retry(3) {
    sh './scp_script.sh'
}
```

3. **Увеличить таймауты** SSH:
```bash
ssh -o ConnectTimeout=30 -o ServerAliveInterval=15 ...
```

## Что делать с результатами диагностики

1. **Если проблема в агенте** - обратитесь к администраторам Jenkins
2. **Если проблема в сети** - обратитесь к сетевой команде
3. **Если проблема в сервере** - проверьте состояние сервера
4. **Если проблема временная** - добавьте retry логику

## Контакты для эскалации

1. **Jenkins администраторы** - проблемы с агентами
2. **Сетевая команда** - проблемы с доступностью портов
3. **Команда серверов** - проблемы с SSH демоном
4. **Команда безопасности** - проблемы с фаерволом

---

**Итог**: Теперь у вас есть полная диагностическая информация для определения точной причины проблемы "ребилд работает, обычный запуск - нет".
