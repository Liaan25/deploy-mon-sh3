# Анализ проблемы HTTP 400 при создании сервисного аккаунта

## Проблема
Функция `create_service_account_via_api` возвращает HTTP 400 (Bad Request) при попытке создания сервисного аккаунта через доменное имя.

## Диагностика из логов

### Успешные этапы:
1. ✅ **Функция вызывается** - `DEBUG_FUNC_START`
2. ✅ **Параметры правильные** - `DEBUG_PARAMS`
3. ✅ **Health check проходит** - `DEBUG_HEALTH_SUCCESS: HTTP 200`
4. ✅ **Создание SA начинается** - `DEBUG_SA_CREATE`

### Проблемный этап:
5. ❌ **HTTP 400 Bad Request** - `DEBUG_SA_RESPONSE: Ответ получен, HTTP код: 400`

## Анализ различий

### Работающий тестовый скрипт:
- **URL**: `https://localhost:3000`
- **Результат**: HTTP 201 (Created), ID сервисного аккаунта: 2

### Не работающий пайплайн:
- **URL**: `https://tvlds-mvp001939.cloud.delta.sbrf.ru:3000`
- **Результат**: HTTP 400 (Bad Request)

## Возможные причины HTTP 400

### 1. **Проблема с SSL/доменным именем**
- Невалидный SSL сертификат для доменного имени
- Проблемы с проверкой hostname
- Reverse proxy или load balancer изменяет запрос

### 2. **Проблема с форматом запроса**
- Неправильный Content-Type
- Неправильный формат JSON
- Неподдерживаемая структура payload
- Проблемы с кодировкой

### 3. **Разница в версиях API**
- Разные версии Grafana (11.4.0 vs 11.6.2)
- Изменения в API между версиями

## Внесенные исправления

### 1. **Добавлено детальное логирование**
- `DEBUG_SA_FULL_RESPONSE` - полный ответ от API
- `DEBUG_SA_BODY` - тело ответа
- `DEBUG_CURL_CMD` - команда curl (без пароля)

### 2. **Добавлена поддержка USE_GRAFANA_LOCALHOST**
Теперь функция `create_service_account_via_api` поддерживает переменную:
```bash
USE_GRAFANA_LOCALHOST=true
```
При установке этой переменной используется `localhost` вместо доменного имени.

### 3. **Созданы диагностические скрипты**
- `debug_400_problem.sh` - детальная диагностика проблемы
- Тестирование разных URL и форматов payload

## Следующие шаги

### Шаг 1: Запустить пайплайн с дополнительным логированием
После наших изменений в логах будет:
- Полный ответ от API (тело ошибки 400)
- Команда curl
- Информация об использовании localhost

### Шаг 2: Проанализировать тело ошибки 400
В теле ответа HTTP 400 обычно содержится детальное описание ошибки:
```json
{
  "message": "Invalid JSON",
  "error": "Detailed error description"
}
```

### Шаг 3: Использовать USE_GRAFANA_LOCALHOST
Если проблема в доменном имени/SSL:
```bash
USE_GRAFANA_LOCALHOST=true
```
Это заставит скрипт использовать `localhost` вместо доменного имени.

### Шаг 4: Проверить разные форматы payload
Скрипт `debug_400_problem.sh` тестирует:
- Без role: `{"name":"SA_NAME"}`
- С role=admin: `{"name":"SA_NAME","role":"admin"}`
- С isDisabled: `{"name":"SA_NAME","role":"admin","isDisabled":false}`

## Временное решение

### Использовать localhost:
```bash
# В настройках пайплайна Jenkins
USE_GRAFANA_LOCALHOST=true
```

### Или в скрипте:
```bash
export USE_GRAFANA_LOCALHOST=true
sudo ./deploy_monitoring_script.sh
```

## Ожидаемые результаты после исправлений

### С текущими изменениями:
1. **Больше информации в логах** - полный ответ от API
2. **Возможность использовать localhost** - через `USE_GRAFANA_LOCALHOST`
3. **Детальная диагностика** - через `debug_400_problem.sh`

### После следующего запуска пайплайна мы увидим:
- Тело ошибки HTTP 400 (что именно не нравится Grafana)
- Будет ли работать с `USE_GRAFANA_LOCALHOST=true`
- Точную причину проблемы

## Рекомендации

1. **Сначала использовать `USE_GRAFANA_LOCALHOST=true`** - чтобы обойти проблему с доменным именем
2. **Проанализировать тело ошибки 400** - понять точную причину
3. **Сравнить запросы** localhost vs доменное имя
4. **Проверить SSL сертификаты** для доменного имени
